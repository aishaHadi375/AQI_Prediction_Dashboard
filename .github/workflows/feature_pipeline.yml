name: Feature Pipeline - Hourly Data Ingestion
'on':
  schedule:
    - cron: 0 * * * *
  workflow_dispatch: null
jobs:
  run-feature-pipeline:
    name: Fetch & Process AQI Data
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v3
      - name: üêç Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: pip
      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests python-dotenv hopsworks hsfs
      - name: üîë Configure Environment
        run: |
          echo "HOPSWORKS_API_KEY=${{ secrets.HOPSWORKS_API_KEY }}" >> .env
          echo "SAVE_LOCAL=False" >> .env
        env:
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}
      - name: üåê Fetch Latest AQI & Weather Data
        run: |
          python src/fetch_data.py
        env:
          PYTHONPATH: ${{ github.workspace }}
      - name: ‚öôÔ∏è Process Raw Data
        run: |
          python src/process_data.py
        env:
          PYTHONPATH: ${{ github.workspace }}
      - name: üßπ Clean Data
        run: |
          python src/clean_data.py
        env:
          PYTHONPATH: ${{ github.workspace }}
      - name: üß† Engineer Features
        run: |
          python src/process_features.py
        env:
          PYTHONPATH: ${{ github.workspace }}
      - name: üì§ Upload to Hopsworks Feature Store
        run: |
          python src/feature_store.py
        env:
          PYTHONPATH: ${{ github.workspace }}
      - name: ‚úÖ Verify Upload
        run: |
          python -c "
          import hopsworks
          import os
          from dotenv import load_dotenv

          load_dotenv()
          api_key = os.getenv('HOPSWORKS_API_KEY')

          project = hopsworks.login(api_key_value=api_key)
          fs = project.get_feature_store()
          fg = fs.get_feature_group('aqi_features', version=2)
          df = fg.read()

          print(f'‚úÖ Feature Store Status:')
          print(f'   Total rows: {len(df)}')
          print(f'   Latest data: {df[\"datetime_str\"].max()}')
          print(f'   Features: {len(df.columns)}')
          "
      - name: üí¨ Notify on Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ö†Ô∏è Feature Pipeline Failed - ' + new Date().toISOString(),
              body: `
              ## Feature Pipeline Execution Failed
              
              **Time:** ${new Date().toLocaleString()}
              **Workflow:** ${context.workflow}
              **Run ID:** ${context.runId}
              
              Please check the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.
              `,
              labels: ['pipeline-failure', 'feature-pipeline', 'urgent']
            })


          
