name: Feature Pipeline - Hourly Data Ingestion

on:
  schedule:
    - cron: 0 * * * *   # runs every hour at 00 min
  workflow_dispatch:

permissions:
  contents: read       # needed for checkout
  issues: write         # needed to create issues

jobs:
  run-feature-pipeline:
    name: Fetch & Process AQI Data
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: üì• Checkout Repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set up Python
      - name: üêç Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: pip

      # 3Ô∏è‚É£ Install dependencies
      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # Install Hopsworks with Python extras (includes pyarrow)
          pip install pandas numpy requests python-dotenv "hopsworks[python]" hsfs

      # 4Ô∏è‚É£ Configure environment and secrets
      - name: üîë Configure Environment
        run: |
          echo "HOPSWORKS_API_KEY=${{ secrets.HOPSWORKS_API_KEY }}" >> .env
          echo "SAVE_LOCAL=False" >> .env
        env:
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}

      # 5Ô∏è‚É£ Fetch latest AQI & weather data
      - name: üåê Fetch Latest AQI & Weather Data
        run: python src/fetch_data.py
        env:
          PYTHONPATH: ${{ github.workspace }}
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}

      # 6Ô∏è‚É£ Process raw data
      - name: ‚öôÔ∏è Process Raw Data
        run: python src/process_data.py
        env:
          PYTHONPATH: ${{ github.workspace }}
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}

      # 7Ô∏è‚É£ Clean data
      - name: üßπ Clean Data
        run: python src/clean_data.py
        env:
          PYTHONPATH: ${{ github.workspace }}
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}

      # 8Ô∏è‚É£ Engineer features
      - name: üß† Engineer Features
        run: python src/process_features.py
        env:
          PYTHONPATH: ${{ github.workspace }}
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}

      # 9Ô∏è‚É£ Upload to Hopsworks Feature Store
      - name: üì§ Upload to Hopsworks Feature Store
        run: python src/feature_store.py
        env:
          PYTHONPATH: ${{ github.workspace }}
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}

      # üîü Verify upload
      - name: ‚úÖ Verify Upload
        run: |
          python -c "
          import hopsworks
          import os
          from dotenv import load_dotenv

          load_dotenv()
          api_key = os.getenv('HOPSWORKS_API_KEY')

          # Login to Hopsworks
          project = hopsworks.login(api_key_value=api_key)

          # Get Feature Store
          fs = project.get_feature_store()
          fg = fs.get_feature_group('aqi_features', version=2)
          df = fg.read()

          print(f'‚úÖ Feature Store Status:')
          print(f'   Total rows: {len(df)}')
          print(f'   Latest data: {df[\"datetime_str\"].max()}')
          print(f'   Features: {len(df.columns)}')
          "

      # 1Ô∏è‚É£1Ô∏è‚É£ Notify on failure
      - name: üí¨ Notify on Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ö†Ô∏è Feature Pipeline Failed - ' + new Date().toISOString(),
              body: `
              ## Feature Pipeline Execution Failed
              
              **Time:** ${new Date().toLocaleString()}
              **Workflow:** ${context.workflow}
              **Run ID:** ${context.runId}
              
              Please check the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.
              `,
              labels: ['pipeline-failure', 'feature-pipeline', 'urgent']
            })



          
